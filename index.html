<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bible Progress (KJV)</title>
  <style>
    :root { --bg:#0b0f19; --card:#121a2a; --text:#e7ecff; --muted:#aab3d0; --accent:#00a3ff; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width: 860px; margin: 0 auto; padding: 28px 16px 40px; }
    .card { background:var(--card); border: 1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { margin: 0 0 6px; font-size: 22px; }
    p { margin: 0 0 14px; color: var(--muted); line-height: 1.45; }
    .row { display:flex; gap:12px; flex-wrap: wrap; }
    .field { flex: 1; min-width: 160px; }
    label { display:block; font-size: 12px; color: var(--muted); margin: 10px 0 6px; }
    select, button { width:100%; padding: 11px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.15); color: var(--text); }
    button { cursor: pointer; background: linear-gradient(180deg, rgba(0,163,255,.22), rgba(0,163,255,.12)); border-color: rgba(0,163,255,.45); font-weight: 650; }
    button:disabled { opacity: .55; cursor: not-allowed; }
    .result { margin-top: 16px; padding: 14px; border-radius: 12px; border: 1px solid rgba(0,163,255,.35); background: rgba(0,163,255,.08); }
    .big { font-size: 34px; font-weight: 800; margin: 2px 0 6px; letter-spacing: .2px; }
    .small { color: var(--muted); font-size: 13px; }
    .status { margin-top: 12px; font-size: 13px; color: var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    a { color: var(--accent); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Bible Progress Calculator (KJV)</h1>
      <p>Select the <b>last verse you’ve completed</b>. Progress is calculated using <b>KJV word counts</b>.</p>

      <div class="row">
        <div class="field">
          <label for="book">Book</label>
          <select id="book" disabled>
            <option>Loading…</option>
          </select>
        </div>
        <div class="field">
          <label for="chapter">Chapter</label>
          <select id="chapter" disabled>
            <option>Select a book</option>
          </select>
        </div>
        <div class="field">
          <label for="verse">Verse</label>
          <select id="verse" disabled>
            <option>Select a chapter</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div class="field" style="min-width:220px; flex:0 0 220px;">
          <button id="calc" disabled>Calculate</button>
        </div>
        <div class="field" style="flex:1; min-width:260px;">
          <div class="status" id="status">Loading data…</div>
        </div>
      </div>

      <div class="result" id="result" style="display:none;">
        <div class="big" id="percent">0.00%</div>
        <div class="small" id="detail"></div>
        <div class="small" style="margin-top:6px;">
          Total words (this dataset): <span class="mono" id="totalWords"></span>
        </div>
      </div>

      <p class="small" style="margin-top:14px;">
        Tip: If the page says it can’t load the JSON, make sure <span class="mono">kjv_word_counts.json</span> is in the same folder as <span class="mono">index.html</span>.
      </p>
    </div>
  </div>

  <script>
    const elBook = document.getElementById('book');
    const elChapter = document.getElementById('chapter');
    const elVerse = document.getElementById('verse');
    const elCalc = document.getElementById('calc');
    const elStatus = document.getElementById('status');
    const elResult = document.getElementById('result');
    const elPercent = document.getElementById('percent');
    const elDetail = document.getElementById('detail');
    const elTotalWords = document.getElementById('totalWords');

    let DATA = null;

    function setStatus(msg) { elStatus.textContent = msg; }

    function clearSelect(selectEl, placeholder) {
      selectEl.innerHTML = '';
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = placeholder;
      selectEl.appendChild(opt);
      selectEl.value = '';
    }

    function fillSelect(selectEl, values, placeholder) {
      clearSelect(selectEl, placeholder);
      for (const v of values) {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        selectEl.appendChild(opt);
      }
    }

    function getBooks() {
      return DATA._order || Object.keys(DATA).filter(k => !k.startsWith('_'));
    }

    function getChapters(book) {
      const b = DATA[book];
      if (!b) return [];
      return Object.keys(b).map(x => parseInt(x, 10)).sort((a,b)=>a-b).map(String);
    }

    function getVerses(book, chapter) {
      const c = DATA?.[book]?.[chapter];
      if (!c) return [];
      return Object.keys(c).map(x => parseInt(x, 10)).sort((a,b)=>a-b).map(String);
    }

    function computeWordsRead(targetBook, targetChapter, targetVerse) {
      const order = getBooks();
      const total = DATA._meta?.totalWords || 0;

      let words = 0;

      for (const book of order) {
        const b = DATA[book];
        if (!b) continue;

        const chapters = Object.keys(b).map(x => parseInt(x,10)).sort((a,b)=>a-b);
        for (const chNum of chapters) {
          const chKey = String(chNum);
          const versesObj = b[chKey];
          const verses = Object.keys(versesObj).map(x => parseInt(x,10)).sort((a,b)=>a-b);

          for (const vNum of verses) {
            const vKey = String(vNum);

            // Add current verse if it is before or equal to selected ref.
            // Stop once we pass the selection.
            const beforeBook = (order.indexOf(book) < order.indexOf(targetBook));
            const sameBook = (book === targetBook);
            const beforeChapter = sameBook && (chNum < parseInt(targetChapter,10));
            const sameChapter = sameBook && (chKey === targetChapter);
            const beforeVerse = sameChapter && (vNum <= parseInt(targetVerse,10));

            if (beforeBook || beforeChapter || beforeVerse) {
              words += (versesObj[vKey] || 0);
            } else {
              // We're past the target; can early exit all loops.
              if (sameBook) return { wordsRead: words, totalWords: total };
              // If not sameBook and not beforeBook, we're beyond, so also stop.
              return { wordsRead: words, totalWords: total };
            }
          }
        }

        // If we've just finished the target book, we can stop.
        if (book === targetBook) break;
      }

      return { wordsRead: words, totalWords: total };
    }

    function enableInputs() {
      elBook.disabled = false;
      elChapter.disabled = false;
      elVerse.disabled = false;
      elCalc.disabled = false;
    }

    function disableInputs() {
      elBook.disabled = true;
      elChapter.disabled = true;
      elVerse.disabled = true;
      elCalc.disabled = true;
    }

    async function init() {
      disableInputs();
      clearSelect(elBook, 'Loading…');
      clearSelect(elChapter, 'Select a book');
      clearSelect(elVerse, 'Select a chapter');

      try {
        setStatus('Loading data…');
        const res = await fetch('./kjv_word_counts.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        DATA = await res.json();

        const books = getBooks();
        fillSelect(elBook, books, 'Select a book');
        clearSelect(elChapter, 'Select a chapter');
        clearSelect(elVerse, 'Select a verse');

        enableInputs();
        setStatus('Ready.');
      } catch (err) {
        setStatus('Could not load kjv_word_counts.json. Check file name + location. (' + err.message + ')');
      }
    }

    elBook.addEventListener('change', () => {
      elResult.style.display = 'none';
      const book = elBook.value;
      if (!book) {
        clearSelect(elChapter, 'Select a chapter');
        clearSelect(elVerse, 'Select a verse');
        return;
      }
      const chapters = getChapters(book);
      fillSelect(elChapter, chapters, 'Select a chapter');
      clearSelect(elVerse, 'Select a verse');
    });

    elChapter.addEventListener('change', () => {
      elResult.style.display = 'none';
      const book = elBook.value;
      const chapter = elChapter.value;
      if (!book || !chapter) {
        clearSelect(elVerse, 'Select a verse');
        return;
      }
      const verses = getVerses(book, chapter);
      fillSelect(elVerse, verses, 'Select a verse');
    });

    elCalc.addEventListener('click', () => {
      elResult.style.display = 'none';

      const book = elBook.value;
      const chapter = elChapter.value;
      const verse = elVerse.value;

      if (!book || !chapter || !verse) {
        setStatus('Pick a book, chapter, and verse.');
        return;
      }

      const total = DATA._meta?.totalWords || 0;
      if (!total) {
        setStatus('Total word count missing in JSON _meta.');
        return;
      }

      const { wordsRead, totalWords } = computeWordsRead(book, chapter, verse);
      const pct = (wordsRead / totalWords) * 100;

      elPercent.textContent = pct.toFixed(2) + '%';
      elDetail.textContent = `Up to ${book} ${chapter}:${verse} — ${wordsRead.toLocaleString()} words read`;
      elTotalWords.textContent = totalWords.toLocaleString();

      elResult.style.display = 'block';
      setStatus('Calculated.');
    });

    init();
  </script>
</body>
</html>

